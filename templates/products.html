{% extends "base.html" %}

{% block container %}
    <div class="container">
        {% include 'subnav.html' %}
        <div class="row">
            <div class="">
                <h1>Products</h1>
            </div>
        </div>

        <div class="row">
            <!--div class="col-sm-1 col-md-6 col-md-offset-3"-->
                <div id="filters" class="button-group pull-left">
                    <div class="form-group"><input type="text" id="quicksearch" class="form-control"
                                                   placeholder="Search"
                                                   style="width: 100%; margin-left: 3px;"/></div>
                    <button class="filter-button btn btn-default button is-checked btn-xs"
                            data-filter="*">{{ _('Show All') }}</button>
                    {% for group in groups %}
                        <button class="button filter-button btn btn-default btn-xs"
                                data-filter=".{{ group.name }}">{{ group.name }}</button>
                    {% endfor %}
                </div>

                <!--/div>

                <div class="col-md-5"-->
                <div class="isotope pull-left col-xs-4 col-md-5" id="products">
                    {% for product in products %}
                        <div class="product-item {{ product.group_list }}" data-category="{{ product.group_list }}">
                            <h3 class="name">{{ product.name }}</h3>

                            <p class="price">{{ product.price }}</p>

                            <p><a href="">Learn More</a></p>
                        </div>
                    {% endfor %}
                </div>
            <!--/div-->
        </div>

        <!--div class="clearfix"></div-->
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}

    <script>
        // debounce so filtering doesn't happen every millisecond
        function debounce(fn, threshold) {
            var timeout;
            return function debounced() {
                if (timeout) {
                    clearTimeout(timeout);
                }
                function delayed() {
                    fn();
                    timeout = null;
                }

                timeout = setTimeout(delayed, threshold || 100);
            }
        }


        function setup_filtering() {
            var qsRegex;
            var buttonFilter;

            // init Isotope
            var $container = $('.isotope').isotope({
                itemSelector: '.product-item',
                layoutMode: 'fitRows',
                filter: function () {
                    var $this = $(this);
                    var searchResult = qsRegex ? $this.text().match(qsRegex) : true;
                    var buttonResult = buttonFilter ? $this.is(buttonFilter) : true;
                    return searchResult && buttonResult;
                }
            });

            $('#filters').on('click', 'button', function () {
                buttonFilter = $(this).attr('data-filter');
                $container.isotope();
                $(".button-group").find(".btn-primary").removeClass("btn-primary");
                $(this).addClass('btn-primary')
            });

            // use value of search field to filter
            var $quicksearch = $('#quicksearch').keyup(debounce(function () {
                qsRegex = new RegExp($quicksearch.val(), 'gi');
                $container.isotope();
            }));


            // change is-checked class on buttons
            $('.button-group').each(function (i, buttonGroup) {
                var $buttonGroup = $(buttonGroup);
                $buttonGroup.on('click', 'button', function () {
                    $buttonGroup.find('.is-checked').removeClass('is-checked');
                    $(this).addClass('is-checked');
                });
            });
        }


        $(document).ready(function () {
            setup_filtering();
        });
    </script>
{% endblock %}
